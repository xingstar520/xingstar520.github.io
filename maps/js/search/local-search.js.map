{"version":3,"file":"../../../js/search/local-search.js","names":["window","addEventListener","loadFlag","dataObj","$searchMask","document","getElementById","openSearch","bodyStyle","body","style","width","overflow","anzhiyu","animateIn","querySelector","setTimeout","focus","search","f","event","code","closeSearch","removeEventListener","animateOut","searchClickFn","fetchData","async","data","response","fetch","path","test","json","res","text","t","DOMParser","parseFromString","querySelectorAll","map","item","tagsArr","getElementsByTagName","Array","prototype","forEach","call","index","push","textContent","content","srcReg","arr","match","srcArr","i","length","src","indexOf","title","url","tags","oneImage","ok","$loadDataItem","nextElementSibling","display","remove","GLOBAL_CONFIG","localSearch","preload","$input","$resultContent","$loadingStatus","keywords","this","value","trim","toLowerCase","split","innerHTML","str","count","then","isMatch","dataTitle","dataTags","dataContent","replace","dataUrl","startsWith","root","indexTitle","indexContent","firstOccur","keyword","start","end","pre","post","matchContent","substring","regS","RegExp","element","languages","hits_empty","pjax","refresh","isHidden"],"sources":["js/search/local-search.js"],"mappings":"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","ignoreList":[],"sourcesContent":["window.addEventListener(\"load\", () => {\n  let loadFlag = false;\n  let dataObj = [];\n  const $searchMask = document.getElementById(\"search-mask\");\n\n  const openSearch = () => {\n    const bodyStyle = document.body.style;\n    bodyStyle.width = \"100%\";\n    bodyStyle.overflow = \"hidden\";\n    anzhiyu.animateIn($searchMask, \"to_show 0.5s\");\n    anzhiyu.animateIn(document.querySelector(\"#local-search .search-dialog\"), \"titleScale 0.5s\");\n    setTimeout(() => {\n      document.querySelector(\"#local-search-input input\").focus();\n    }, 100);\n    if (!loadFlag) {\n      search();\n      loadFlag = true;\n    }\n    // shortcut: ESC\n    document.addEventListener(\"keydown\", function f(event) {\n      if (event.code === \"Escape\") {\n        closeSearch();\n        document.removeEventListener(\"keydown\", f);\n      }\n    });\n  };\n\n  const closeSearch = () => {\n    const bodyStyle = document.body.style;\n    bodyStyle.width = \"\";\n    bodyStyle.overflow = \"\";\n    anzhiyu.animateOut(document.querySelector(\"#local-search .search-dialog\"), \"search_close .5s\");\n    anzhiyu.animateOut($searchMask, \"to_hide 0.5s\");\n  };\n\n  const searchClickFn = () => {\n    document.querySelector(\"#search-button > .search\").addEventListener(\"click\", openSearch);\n    document.querySelector(\"#menu-search\").addEventListener(\"click\", openSearch);\n  };\n\n  const searchClickFnOnce = () => {\n    document.querySelector(\"#local-search .search-close-button\").addEventListener(\"click\", closeSearch);\n    $searchMask.addEventListener(\"click\", closeSearch);\n    if (GLOBAL_CONFIG.localSearch.preload) dataObj = fetchData(GLOBAL_CONFIG.localSearch.path);\n  };\n\n  // check url is json or not\n  const isJson = url => {\n    const reg = /\\.json$/;\n    return reg.test(url);\n  };\n\n  const fetchData = async path => {\n    let data = [];\n    const response = await fetch(path);\n    if (isJson(path)) {\n      data = await response.json();\n    } else {\n      const res = await response.text();\n      const t = await new window.DOMParser().parseFromString(res, \"text/xml\");\n      const a = await t;\n\n      data = [...a.querySelectorAll(\"entry\")].map(item => {\n        let tagsArr = [];\n        if (item.querySelector(\"tags\") && item.querySelector(\"tags\").getElementsByTagName(\"tag\")) {\n          Array.prototype.forEach.call(item.querySelector(\"tags\").getElementsByTagName(\"tag\"), function (item, index) {\n            tagsArr.push(item.textContent);\n          });\n        }\n        let content = item.querySelector(\"content\") && item.querySelector(\"content\").textContent;\n        let imgReg = /<img.*?(?:>|\\/>)/gi; //匹配图片中的img标签\n        let srcReg = /src=[\\'\\\"]?([^\\'\\\"]*)[\\'\\\"]?/i; // 匹配图片中的src\n        let arr = content.match(imgReg); //筛选出所有的img\n\n        let srcArr = [];\n        if (arr) {\n          for (let i = 0; i < arr.length; i++) {\n            let src = arr[i].match(srcReg);\n            // 获取图片地址\n            if (!src[1].indexOf(\"http\")) srcArr.push(src[1]);\n          }\n        }\n\n        return {\n          title: item.querySelector(\"title\").textContent,\n          content: content,\n          url: item.querySelector(\"url\").textContent,\n          tags: tagsArr,\n          oneImage: srcArr && srcArr[0],\n        };\n      });\n    }\n    if (response.ok) {\n      const $loadDataItem = document.getElementById(\"loading-database\");\n      $loadDataItem.nextElementSibling.style.display = \"block\";\n      $loadDataItem.remove();\n    }\n    return data;\n  };\n\n  const search = () => {\n    if (!GLOBAL_CONFIG.localSearch.preload) {\n      dataObj = fetchData(GLOBAL_CONFIG.localSearch.path);\n    }\n    const $input = document.querySelector(\"#local-search-input input\");\n    const $resultContent = document.getElementById(\"local-search-results\");\n    const $loadingStatus = document.getElementById(\"loading-status\");\n\n    $input.addEventListener(\"input\", function () {\n      const keywords = this.value.trim().toLowerCase().split(/[\\s]+/);\n      if (keywords[0] !== \"\")\n        $loadingStatus.innerHTML = '<i class=\"anzhiyufont anzhiyu-icon-spinner anzhiyu-pulse-icon\"></i>';\n\n      $resultContent.innerHTML = \"\";\n      let str = '<div class=\"search-result-list\">';\n      if (keywords.length <= 0) return;\n      let count = 0;\n      // perform local searching\n      dataObj.then(data => {\n        data.forEach(data => {\n          let isMatch = true;\n          let dataTitle = data.title ? data.title.trim().toLowerCase() : \"\";\n          let dataTags = data.tags;\n          let oneImage = data.oneImage ?? \"\";\n          const dataContent = data.content\n            ? data.content\n                .trim()\n                .replace(/<[^>]+>/g, \"\")\n                .toLowerCase()\n            : \"\";\n          const dataUrl = data.url.startsWith(\"/\") ? data.url : GLOBAL_CONFIG.root + data.url;\n          let indexTitle = -1;\n          let indexContent = -1;\n          let firstOccur = -1;\n          // only match articles with not empty titles and contents\n          if (dataTitle !== \"\" || dataContent !== \"\") {\n            keywords.forEach((keyword, i) => {\n              indexTitle = dataTitle.indexOf(keyword);\n              indexContent = dataContent.indexOf(keyword);\n              if (indexTitle < 0 && indexContent < 0) {\n                isMatch = false;\n              } else {\n                if (indexContent < 0) {\n                  indexContent = 0;\n                }\n                if (i === 0) {\n                  firstOccur = indexContent;\n                }\n              }\n            });\n          } else {\n            isMatch = false;\n          }\n\n          // show search results\n          if (isMatch) {\n            if (firstOccur >= 0) {\n              // cut out 130 characters\n              // let start = firstOccur - 30 < 0 ? 0 : firstOccur - 30\n              // let end = firstOccur + 50 > dataContent.length ? dataContent.length : firstOccur + 50\n              let start = firstOccur - 30;\n              let end = firstOccur + 100;\n              let pre = \"\";\n              let post = \"\";\n\n              if (start < 0) {\n                start = 0;\n              }\n\n              if (start === 0) {\n                end = 100;\n              } else {\n                pre = \"...\";\n              }\n\n              if (end > dataContent.length) {\n                end = dataContent.length;\n              } else {\n                post = \"...\";\n              }\n\n              let matchContent = dataContent.substring(start, end);\n\n              // highlight all keywords\n              keywords.forEach(keyword => {\n                const regS = new RegExp(keyword, \"gi\");\n                matchContent = matchContent.replace(regS, '<span class=\"search-keyword\">' + keyword + \"</span>\");\n                dataTitle = dataTitle.replace(regS, '<span class=\"search-keyword\">' + keyword + \"</span>\");\n              });\n\n              str += '<div class=\"local-search__hit-item\">';\n              if (oneImage) {\n                str += `<div class=\"search-left\"><img src=${oneImage} alt=${dataTitle} data-fancybox='gallery'>`;\n              } else {\n                str += '<div class=\"search-left\" style=\"width:0\">';\n              }\n\n              str += \"</div>\";\n\n              if (oneImage) {\n                str +=\n                  '<div class=\"search-right\"><a href=\"' +\n                  dataUrl +\n                  '\" class=\"search-result-title\">' +\n                  dataTitle +\n                  \"</a>\";\n              } else {\n                str +=\n                  '<div class=\"search-right\" style=\"width: 100%\"><a href=\"' +\n                  dataUrl +\n                  '\" class=\"search-result-title\">' +\n                  dataTitle +\n                  \"</a>\";\n              }\n\n              count += 1;\n\n              if (dataContent !== \"\") {\n                str +=\n                  '<p class=\"search-result\" onclick=\"pjax.loadUrl(`' +\n                  dataUrl +\n                  '`)\">' +\n                  pre +\n                  matchContent +\n                  post +\n                  \"</p>\";\n              }\n              if (dataTags.length) {\n                str += '<div class=\"search-result-tags\">';\n\n                for (let i = 0; i < dataTags.length; i++) {\n                  const element = dataTags[i].trim();\n\n                  str +=\n                    '<a class=\"tag-list\" href=\"/tags/' +\n                    element +\n                    '/\" data-pjax-state=\"\" one-link-mark=\"yes\">#' +\n                    element +\n                    \"</a>\";\n                }\n\n                str += \"</div>\";\n              }\n            }\n            str += \"</div></div>\";\n          }\n        });\n        if (count === 0) {\n          str +=\n            '<div id=\"local-search__hits-empty\">' +\n            GLOBAL_CONFIG.localSearch.languages.hits_empty.replace(/\\$\\{query}/, this.value.trim()) +\n            \"</div>\";\n        }\n        str += \"</div>\";\n        $resultContent.innerHTML = str;\n        if (keywords[0] !== \"\") $loadingStatus.innerHTML = \"\";\n        window.pjax && window.pjax.refresh($resultContent);\n      });\n    });\n  };\n\n  searchClickFn();\n  searchClickFnOnce();\n\n  // pjax\n  window.addEventListener(\"pjax:complete\", () => {\n    !anzhiyu.isHidden($searchMask) && closeSearch();\n    searchClickFn();\n  });\n});\n"]}